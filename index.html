<!DOCTYPE html>
<html>

<head>
    <title>!DOCTYPE</title>
    <meta charset="utf-8">
    <script src="jquery-3.3.1.min.js"></script>
    <script src="xlsx.core.min.js"></script>
    <script src="download.js"></script>
    <style>
        @font-face {
            font-family: KTP900RUS;
            src: url('KTP900RUS.ttf');
        }


        html {
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100%;
            font-family: KTP900RUS;
            overflow: hidden;
        }

        body {
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100%;
        }

        #StockView {
            font-size: 24px;
            border: 0px;
            padding: 2px 2px 2px 2px;
            margin: 0;
        }

        .row {
            box-sizing: border-box;
            display: flex;
            padding: 2px 0px 2px 0px;
            margin: 0;
        }

        .cell {
            box-sizing: border-box;
            background: rgb(231, 231, 231);
            color: rgb(0, 65, 255);
            border: 2px solid rgb(0, 65, 255);
            white-space: nowrap;
            padding: 4px 4px 4px 4px;
            margin: 0px 2px 0px 2px;
            display: flex;
            flex-direction: column;
        }

        .row .cell {
            width: 100%;
            height: 100%;
            overflow: hidden;
            table-layout: fixed;
        }

        div.CellHead {
            text-align: center;
            font-weight: bold;
            font-size: 26px;
        }

        #MainFooter {
            box-sizing: border-box;
            padding: 8px 4px 8px 4px;
            margin: 0;
            display: flex;
            flex-direction: row;
            overflow: hidden;
            border: 2px solid rgb(231, 231, 231);
            background: rgb(0, 65, 255);
        }




        #FooterLogo {
            background: rgb(0, 65, 255) url(image.svg) no-repeat center right;
            background-size: contain;
        }

        #MainFooter .Button {
            box-sizing: border-box;
            margin: 0px 4px 0px 4px;
            overflow: hidden;
            display: flex;
            flex-direction: row;
            font-family: KTP900RUS;
            font-size: 48px;
            background: rgb(0, 65, 255);
            color: rgb(231, 231, 231);
            align-items: center;
            cursor: pointer;
            height: 100%;
            justify-content: center;
            padding: 5px 5px 5px 5px;
            border: 2px solid rgb(231, 231, 231);
            border-radius: 10px;
            outline:none;
        }
    </style>
</head>

<body style="display: flex;flex-direction: column">

    <div id="StockView" style="width:100%;height:90%;background: rgb(231, 231,231);overflow: scroll;padding: 0;margin: 0">

    </div>

    <div id="MainFooter" class='FooterFull'>

        <button class='Button' onclick="UpdateStock()">
            <span>Обновить</span>
        </button>

        <button class='Button' onclick="SaveFile()">
            <span>Сохранить</span>
        </button>

        <div id="FooterLogo"></div>

    </div>

    <svg width="0px" height="0">
        <symbol id="Box">
            <path fill="#0041ff" d="M443.215,199.258l-64-37.6l64-37.6c3.2-1.6,4-5.2,2.4-8c-0.4-0.8-1.2-1.6-2-2l-72.4-42.4l-72.8-42.8c-2-1.2-4-1.2-6,0
                        l-69.2,40.8l-69.6-40.8c-1.6-1.2-4-1.2-6,0l-72.4,42.8l-72,42.4c-0.8,0.4-1.6,1.2-2,2c-1.6,2.8-0.8,6.4,2,8l64,37.6l-64.4,37.6
                        c-2.8,1.6-3.6,5.2-2,8c0.4,0.8,1.2,1.6,2,2l69.6,40.8v79.2c0,2,1.2,4,2.8,4.8l144,83.2c0.4,0,0.4,0.4,0.8,0.4c0,0,0.4,0,0.4,0.4
                        c0.8,0.4,1.2,0.4,2,0.4s1.2,0,2-0.4c0,0,0.4,0,0.4-0.4c0.4,0,0.4,0,0.8-0.4l143.6-83.2c2-1.2,2.8-3.2,2.8-4.8v-78.4l71.2-41.6
                        c0.8-0.4,1.6-1.2,2-2C446.816,204.458,446.015,200.858,443.215,199.258z M295.616,40.458l69.6,40.8l64,37.6l-61.2,36l-69.6-40.8
                        l-64-37.6L295.616,40.458z M229.215,86.458l63.6,37.6l64,37.6l-64,37.6l-20.4,12l-43.2-25.2V86.458z M17.215,118.858l64-37.6
                        l69.6-40.8l61.2,36l-64,37.6l-69.6,40.8L17.215,118.858z M217.215,86.458v99.6l-43.2,25.2l-20.4-12l-64-37.6l64-37.6
                        L217.215,86.458z M81.215,241.658l-64-37.6l61.2-36l69.6,40.8l64,37.6l-61.2,36l-69.2-40.4L81.215,241.658z M216.415,402.858
                        l-132.4-76.8v-69.2l63.6,37.6c2,1.2,4,1.2,6,0l62.8-36.8V402.858z M223.215,240.058l-37.6-22l37.6-22l37.6,22L223.215,240.058z
                         M360.816,326.058l-132.4,76.8v-146.8l64.4,38c1.6,1.2,4,1.2,6,0l62-36.4V326.058z M365.215,241.658l-2,1.2l-67.6,39.6l-61.2-36
                        l64-37.6l69.6-40.8l61.2,36L365.215,241.658z" />
        </symbol>

        <symbol id='Loading' viewBox="0 0 12362 3013" width="67.7332mm" height="16.51mm">
            <defs>

                <style type="text/css">
                    .str1 {
                        stroke: rgb(0, 65, 255);
                        stroke-width: 30.9001
                    }

                    .str0 {
                        stroke: rgb(0, 65, 255);
                        stroke-width: 13.9078
                    }

                    .fil2 {
                        fill: rgb(231, 231, 231)
                    }

                    .fil1 {
                        fill: rgb(0, 65, 255)
                    }
                </style>
            </defs>
            <g id="_937674800">
                <path class="fil1 str0" d="M9312 2036c44,4 102,1 147,1 97,0 81,13 92,-57 14,-85 29,-170 43,-256 14,-87 29,-171 42,-258 12,-87 18,-182 32,-268 -4,48 84,822 92,834 9,8 -6,0 8,4l173 0c12,-13 246,-547 273,-611 29,-67 53,-145 82,-209 -3,53 -31,143 -43,199 -14,68 -104,588 -104,622l286 0 135 -799 131 0c40,92 44,315 31,422 -41,351 -252,670 -545,847 -388,234 -872,249 -1272,11 -54,-33 -112,-79 -137,-93 14,-22 23,-13 37,-32l-363 -126 41 333c16,-4 50,-30 68,-40 17,8 28,22 43,34 50,40 71,58 130,97 195,128 422,212 667,235 852,77 1596,-571 1578,-1418 -3,-128 -25,-267 -65,-386 -6,-19 -37,-99 -38,-108l-687 1 -233 526 -63 -527 -413 1 -168 1021z"
                />
                <path class="fil1 str0" d="M8383 1815c-39,-104 -44,-305 -30,-422 94,-786 949,-1236 1663,-932 74,31 245,121 290,174l-44 32 362 127 -41 -333c-18,4 -53,33 -75,44 -48,-27 -117,-120 -364,-232 -733,-336 -1640,4 -1943,766 -124,311 -128,689 0,998 119,0 456,9 553,-16 71,-18 144,-67 177,-106 62,-74 162,-261 213,-354 32,-58 278,-506 305,-547l-282 1 -222 403 -126 -404 -322 2c14,42 36,87 53,130l215 530c13,30 25,39 7,64 -17,23 -22,32 -46,47 -63,40 -256,28 -343,28z"
                />
                <path class="fil1 str0" d="M5218 2036l293 0c12,-30 43,-248 54,-310 2,-12 9,-99 24,-103l257 0c-8,70 -69,386 -66,413l293 0 172 -1021 -297 -1 -62 376 -263 -1 60 -375 -297 0c-30,169 -56,340 -85,509 -11,66 -85,486 -83,513z"
                />
                <path class="fil1 str0" d="M4340 2036l750 0 41 -233 -455 0 28 -181 368 -1 38 -222 -368 0 25 -162 438 0 39 -223 -736 0c-9,53 -170,991 -168,1022z"
                />
                <path class="fil1 str0" d="M4281 1675c-46,-5 -248,-38 -272,-30 -27,61 -43,140 -121,162 -26,7 -61,7 -85,-2 -101,-36 -79,-189 -61,-294 19,-106 42,-225 114,-270 46,-29 114,-23 147,12 32,34 40,96 41,155l290 -20c-7,-275 -213,-439 -504,-388 -383,66 -522,599 -351,873 145,230 460,234 631,87 36,-32 74,-73 104,-123 17,-28 67,-125 67,-162z"
                />
                <path class="fil1 str0" d="M6605 1616c5,-27 90,-202 112,-255l17 -31c1,-2 2,-2 3,-2l37 288 -169 0zm-182 420c15,-17 83,-177 96,-208l278 2c6,40 10,80 15,119 12,102 2,88 44,88 89,-2 178,-1 267,-1 3,-26 -119,-784 -136,-894l-20 -124c-25,-11 -272,-4 -322,-4l-471 1022 249 0z"
                />
                <path class="fil1 str0" d="M1846 1616c3,-19 117,-271 130,-292l38 292 -168 0zm-86 212l278 1 27 208 300 -1 -157 -1022 -323 1 -471 1021 252 1 94 -209z"
                />
                <path class="fil1 str0" d="M2880 1235c99,0 218,-1 196,120 -16,94 -135,87 -230,87l34 -207zm-64 426c165,0 303,19 422,-67 142,-102 195,-362 31,-503 -39,-34 -101,-65 -170,-71 -60,-6 -434,-11 -480,-4l-168 1020 294 0c12,-37 39,-223 50,-286 3,-16 6,-33 8,-49 6,-39 2,-33 13,-40z"
                />
                <path class="fil1 str0" d="M7158 2036l247 0 70 -161c23,-55 46,-109 70,-164 19,-42 131,-315 141,-329 17,65 28,158 40,228l59 345c17,98 5,82 55,82 84,-1 187,5 269,-1 -1,-24 -90,-473 -97,-509 -17,-85 -33,-170 -49,-255 -16,-85 -32,-178 -50,-257l-296 -1c-19,27 -459,1016 -459,1022z"
                />
            </g>
            <g id="_937671504">
                <path class="fil2 str1" d="M9265 1990c45,3 102,0 148,0 97,0 81,13 92,-56 14,-86 29,-171 43,-256 14,-87 29,-172 41,-258 13,-88 18,-182 33,-268 -5,48 84,821 92,833 8,8 -6,1 8,4l173 1c11,-14 245,-548 273,-611 29,-67 53,-145 82,-209 -3,53 -32,142 -43,199 -14,68 -105,588 -104,621l285 1 136 -799 131 0c39,91 43,314 31,421 -41,351 -252,671 -545,848 -388,234 -873,249 -1272,10 -54,-32 -112,-78 -137,-93 14,-21 23,-13 36,-31l-362 -127 41 333c15,-3 50,-30 67,-40 18,9 28,22 44,35 50,40 71,58 130,96 195,129 421,213 667,235 851,78 1595,-570 1578,-1417 -3,-129 -26,-267 -65,-387 -6,-18 -38,-98 -38,-107l-687 1 -233 526 -64 -527 -412 0 -169 1022z"
                />
                <path class="fil2 str1" d="M8336 1768c-38,-103 -44,-304 -30,-421 95,-786 950,-1236 1664,-932 74,31 244,121 289,174l-44 32 363 126 -41 -333c-19,5 -53,34 -76,44 -47,-26 -117,-119 -363,-232 -733,-335 -1641,4 -1944,766 -124,311 -127,690 0,999 120,0 457,9 553,-16 71,-19 145,-67 178,-106 62,-74 162,-261 213,-354 31,-58 277,-507 305,-547l-282 0 -222 404 -126 -404 -322 1c14,43 36,88 53,131l215 529c12,30 25,40 7,64 -17,24 -23,32 -46,47 -63,40 -256,28 -344,28z"
                />
                <path class="fil2 str1" d="M5172 1990l293 0c11,-30 43,-248 53,-310 2,-12 10,-99 25,-103l256 0c-7,69 -69,385 -65,413l293 0 172 -1022 -298 0 -61 375 -264 0 61 -375 -297 0c-31,169 -57,339 -85,509 -11,66 -86,485 -83,513z"
                />
                <path class="fil2 str1" d="M4293 1990l750 0 42 -233 -456 -1 28 -180 368 -1 38 -223 -367 0 25 -161 437 0 39 -223 -735 0c-9,53 -171,990 -169,1022z"
                />
                <path class="fil2 str1" d="M4234 1629c-45,-5 -247,-38 -271,-30 -27,61 -43,140 -121,162 -27,7 -61,6 -86,-2 -100,-36 -79,-189 -60,-294 19,-107 42,-225 114,-271 46,-29 113,-23 146,12 33,35 41,97 41,155l290 -20c-6,-274 -212,-439 -503,-388 -384,67 -522,600 -351,874 145,230 459,233 630,86 37,-32 75,-73 105,-122 17,-28 66,-125 66,-162z"
                />
                <path class="fil2 str1" d="M6559 1570c5,-27 89,-202 112,-255l17 -31c0,-2 2,-2 2,-3l38 289 -169 0zm-182 420c15,-18 83,-177 96,-208l278 2c6,40 10,80 15,119 12,102 2,88 44,87 88,-1 178,0 266,0 3,-26 -118,-784 -135,-894l-20 -125c-25,-10 -273,-3 -323,-3l-470 1022 249 0z"
                />
                <path class="fil2 str1" d="M1799 1570c4,-19 118,-271 131,-292l38 292 -169 0zm-85 212l277 1 27 207 301 -1 -157 -1021 -323 0 -471 1022 251 0 95 -208z"
                />
                <path class="fil2 str1" d="M2834 1189c99,0 217,-1 196,120 -17,94 -135,87 -230,86l34 -206zm-64 426c165,0 302,19 422,-67 141,-102 194,-362 31,-503 -39,-34 -102,-65 -171,-72 -59,-5 -433,-11 -479,-4l-169 1021 295 0c11,-37 39,-223 50,-287 2,-16 5,-32 8,-48 6,-39 2,-33 13,-40z"
                />
                <path class="fil2 str1" d="M7111 1990l247 0 70 -161c24,-55 47,-109 71,-164 18,-43 131,-315 141,-329 17,65 28,158 40,228l58 345c17,98 6,82 56,81 84,-1 187,6 268,-1 0,-24 -90,-473 -97,-509 -16,-85 -33,-170 -49,-254 -16,-85 -31,-179 -50,-258l-295 0c-19,27 -459,1015 -460,1022z"
                />
                <rect fill="rgb(0,65,255)" stroke="rgb(0,65,255)" stroke-width="30" x="1397px" y="2247px" width="6950px" height="300px" />
                <rect fill="rgb(231,231,231)" stroke="rgb(0,65,255)" stroke-width="30" x="1350px" y="2200px" width="6950px" height="300px"
                />

                <rect id="LoadBar" fill="rgb(0,65,255)" stroke="rgb(0,65,255)" stroke-width="30" x="1425px" y="2275px" width="0px" height="150px"
                />
            </g>
        </symbol>
    </svg>

    <script type='text/javascript'>
        window.addEventListener('resize', OnPreResize, true);
        window.addEventListener('resize', OnPostResize, false);

        function OnPreResize() {
            var w = jQuery(window).width();
            var h = jQuery(window).height();
            if (w > h) {
                if (w / 2 > h) {

                    $("#MainFooter").height(w / h * 10 + '%');
                    $("#FooterLogo").show();
                    $('.Button').width($("#MainFooter").width() / 3);
                } else {

                    $("#MainFooter").height('10%');
                    $("#FooterLogo").show();
                    $('.Button').width($("#MainFooter").width() / 3);
                }

            } else {

                $("#MainFooter").height('10%');
                $("#FooterLogo").hide();
                $('.Button').width($("#MainFooter").width() / 2);
            }
        }

        function OnPostResize() {
            $('.Button span').css("fontsize", '48px');
            $('.Button').textfill(96);
            var width = $('#MainFooter').width() - 8;
            $('.Button').each(function () {
                width -= $(this).width() + 8;
            });
            $("#FooterLogo").width(width);
        }

        String.prototype.decode_CER_first_pass = function () {
            return this
                .replace(/&#x([\da-f]{2,4});/gi,
                    function ($0, $1) {
                        return String.fromCharCode("0x" + $1)
                    });
        }

        String.prototype.decode_CER_second_pass = function () {
            return this
                .replace(/&#x([\da-f]{2,4});/gi,
                    function ($0, $1) {
                        var hex = parseInt($1, 16);
                        if (hex > 191 && hex < 256) {
                            return String.fromCharCode(1040 + hex - 192);
                        } else {
                            return String.fromCharCode("0x" + $1)
                        }
                    });
        }

        String.prototype.decode_CER = function () {
            return this.decode_CER_first_pass().decode_CER_second_pass().slice(1, -1);
        }

        var json;

        $(document).ready(function () {
            $.ajaxSetup({
                cache: false
            });
            UpdateStock();
            OnPreResize();
            OnPostResize();
        });

        var load_complete = 0;

        async function parallel() {
            load_complete = 0;
            $("#LoadBar").width(6800 / 20 * load_complete + 'px');
            const task = new Array(20);
            const json = new Array(20);

            for (var i = 0; i < 20; i++) {
                console.log('Start task ' + i.toString());
                task[i] = $.getJSON("Stock_" + i.toString() + ".htm", function (json) {
                    load_complete += 1;
                    $("#LoadBar").width(6800 / 20 * load_complete + 'px');
                    console.log('Task done ' + load_complete.toString() + "%");
                });
            }
            for (var i = 0; i < 20; i++) {
                json[i] = await task[i];
            }
            return json;
        }

        async function UpdateStock() {
            let startTime = performance.now();
            $('#StockView').html(
                //'<div style=\'width:100%;height:100%;background: url(image.svg) no-repeat center;background-size: contain;\'><svg viewBox=\'0 0 64 64\' style=\'display:block;width:100%;height:100%;\'><use xlink:href=\'#Loading\'/></svg></div>'
                '<svg viewBox=\'0 0 12362 3013\' style=\'display:block;width:100%;height:100%;\'><use xlink:href=\'#Loading\'/></svg>'
            );
            json = await parallel();
            console.log(`Load tags finished in ${ Number.parseInt(performance.now() - startTime) } miliseconds with`);
            startTime = performance.now();
            var tbl = document.createElement('div');
            var xmax = 0;
            var ymax = 0;
            $('#StockView').html(
                '<div id=\'MeasureCell\' class=\'cell\' style=\'display: inline-block;overflow: hidden;\'></div>'
            );
            var msr = document.getElementById('MeasureCell');
            for (var k = 0; k < 2; k++) {
                for (var i = 0; i <10; i++) {
                    var tr = document.createElement('div');
                    for (var j = 0; j < 10; j++) {
                        var td = document.createElement('div');
                        td.className = 'cell';
                        td.setAttribute('index', k.toString() + " - " + i.toString() + " - " + j.toString());
                        var value = "";
                        var item = json[k * 10 + i].items[j];
                        if (item.Busy == 1) {
                            value = "<div class=\"CellHead\">" + k.toString() + " - " + i.toString() + " - " + j.toString() +
                                "</div>";
                            value += "Дата поставки: " + item.Date.decode_CER() + "<br>";
                            value += "Тип двигателя: " + item.EngineType.decode_CER() + "<br>";
                            value += "Номер двигателя: " + item.EngineNumber.decode_CER() + "<br>";
                            value += "Шифр детали: " + item.EngineCode.decode_CER() + "<br>";
                            value += "Наименование детали: " + item.Name.decode_CER() + "<br>";
                            value += "Количество: " + item.Amount.decode_CER();
                        } else {
                            value = 'empty'
                        };
                        msr.innerHTML = value;
                        var width = msr.clientWidth;
                        var height = msr.clientHeight;
                        xmax = xmax < width ? width : xmax;
                        ymax = ymax < height ? height : ymax;
                        td.innerHTML = value;
                        tr.appendChild(td);
                    }
                    tbl.appendChild(tr);
                }
            }
            xmax += 8;
            ymax += 8;
            $("#StockView").html(tbl.innerHTML);


            var $rows = $('#StockView').children();
            var width = document.body.clientWidth;
            var height = $("#StockView").height();

            xmax *= 10;
            width = xmax < width ? width : xmax;
            height = ymax * 20 < height ? height / 20 - 8 : ymax - 8;

            $rows.each(function () {
                $(this).attr('class', 'row');
                $(this).width(width);
                $(this).height(height);
            });

            $rows.each(function () {
                var $cells = $(this).find('.cell');
                $cells.each(function () {
                    if ($(this).text() == 'empty') {
                        $(this).html("<div class=\"CellHead\">" + $(this).attr(
                                'index') +
                            "</div><svg viewBox='0 0 447 447' display='block'><use xlink:href=\"#Box\"/></svg>"
                        );
                    }
                });
            });
            console.log(`Proccessing finished in ${ Number.parseInt(performance.now() - startTime) } miliseconds with`);
        }

        function s2ab(s) {
            var buf = new ArrayBuffer(s.length);
            var view = new Uint8Array(buf);
            for (var i = 0; i < s.length; i++) {
                view[i] = s.charCodeAt(i) & 0xFF;
            }

            return buf;

        }

        function save_xsls() {

            var currentTime = new Date(),
                month = (currentTime.getMonth() + 1).toString(),
                day = currentTime.getDate().toString(),
                year = currentTime.getFullYear().toString();

            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;

            var wb = XLSX.utils.book_new();
            wb.Props = {
                Title: "Склад",
                Subject: "",
                Author: "",
                CreatedDate: currentTime
            };

            var name = 'Склад ' + day + '.' + month + "." + year;

            wb.SheetNames.push(name);

            var ws_data = [];
            ws_data.push(['Ячейка', 'Занята', 'Дата поставки', 'Тип двигателя', 'Номер двигателя', 'Шифр детали',
                'Наименование детали', 'Количество'
            ]);

            for (var k = 0; k < 2; k++) {
                for (var i = 0; i < 10; i++) {
                    for (var j = 0; j < 10; j++) {
                        ws_data[k * 100 + i * 10 + j + 1] = [];
                        var cell = ws_data[k * 100 + i * 10 + j + 1];
                        var item = json[i].items[j];
                        cell[0] = k.toString() + " - " + i.toString() + " - " + j.toString();
                        if (item.Busy == 1) {
                            cell[1] = 'Занята';
                        } else {
                            cell[1] = 'Пуста';
                        }
                        cell[2] = item.Date.decode_CER();
                        cell[3] = item.EngineType.decode_CER();
                        cell[4] = item.EngineNumber.decode_CER();
                        cell[5] = item.EngineCode.decode_CER();
                        cell[6] = item.Name.decode_CER();
                        cell[7] = item.Amount.decode_CER();
                    }
                }
            }

            var ws = XLSX.utils.aoa_to_sheet(ws_data);
            wb.Sheets[name] = ws;
            var wbout = XLSX.write(wb, {
                bookType: 'xlsx',
                type: 'binary'
            });

            download(new Blob([s2ab(wbout)]), 'test.xlsx', 'application/octet-stream');

        }

        function SaveFile() {
            save_xsls();
        }

        (function ($) {
            $.fn.textfill = function (maxFontSize) {
                maxFontSize = parseInt(maxFontSize, 10);
                return this.each(function () {
                    var ourText = $("span", this),
                        parent = ourText.parent(),
                        maxHeight = parent.height(),
                        maxWidth = parent.width(),
                        fontSize = parseInt(ourText.css("fontSize"), 10),
                        multiplier = maxWidth / ourText.width() < maxHeight / ourText.height() ?
                        maxWidth / ourText.width() : maxHeight / ourText.height(),
                        newSize = (fontSize * (multiplier - 0.1));
                    ourText.css(
                        "fontSize",
                        (maxFontSize > 0 && newSize > maxFontSize) ?
                        maxFontSize :
                        newSize
                    );
                });
            };
        })(jQuery);
    </script>
</body>

</html>